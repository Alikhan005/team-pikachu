
{% extends 'reservations/base.html' %}
{% load static %}
{% block content %}
<div class="container">
  <h2 class="text-center mb-4">üìÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª–∏–∫</h2>

  <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
  {% if messages %}
    <div class="container">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="d-flex justify-content-center">
    <form method="post" action="{% url 'booking_create' %}" class="bg-light p-4 rounded shadow-sm" style="max-width: 500px; width: 100%;">
      {% csrf_token %}

      <!-- –í—ã–±–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ -->
      <div class="mb-3">
        <label for="restaurantSelect" class="form-label">üè¢ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω:</label>
        <select name="restaurant" id="restaurantSelect" class="form-select" required>
          <option value="" selected disabled>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω...</option>
          {% for restaurant in restaurants %}
            <option value="{{ restaurant.id }}">{{ restaurant.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- –í—ã–±–æ—Ä —Å—Ç–æ–ª–∏–∫–æ–≤ -->
      <div class="mb-3">
        <label class="form-label">üçΩÔ∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–æ–ª–∏–∫–∏:</label>
        <div id="tableList" class="list-group">
          <p class="text-muted">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω...</p>
        </div>
      </div>

      <!-- –ü–æ–ª–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–æ–ª–∏–∫–∞ -->
      <input type="hidden" name="selected_table" id="selectedTable">

      <!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ -->
      <div class="mb-3">
        <label for="bookingDate" class="form-label">‚è∞ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
        <input type="datetime-local" name="booking_date" id="bookingDate" class="form-control" required disabled>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
      <button type="submit" id="confirmButton" class="btn btn-success w-100" disabled>
        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å
      </button>
    </form>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <div class="mt-3 text-center">
    <a href="{% url 'my_bookings' %}" class="btn btn-outline-secondary">üîô –ù–∞–∑–∞–¥ –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º</a>
  </div>
</div>

<!-- JavaScript –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–ª–∏–∫–æ–≤ -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const restaurantSelect = document.getElementById("restaurantSelect");
    const tableList = document.getElementById("tableList");
    const selectedTableInput = document.getElementById("selectedTable");
    const bookingDate = document.getElementById("bookingDate");
    const confirmButton = document.getElementById("confirmButton");

    restaurantSelect.addEventListener("change", function() {
      const restaurantId = this.value;

      // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç–æ–ª–∏–∫–æ–≤
      tableList.innerHTML = '<p class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
      bookingDate.disabled = true;
      confirmButton.disabled = true;
      selectedTableInput.value = "";

      // –ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
      fetch(`/get_available_tables/${restaurantId}/`)
        .then(response => {
          if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–ª–∏–∫–æ–≤");
          }
          return response.json();
        })
        .then(data => {
          tableList.innerHTML = "";
          if (data.tables.length > 0) {
            data.tables.forEach(table => {
              const tableButton = document.createElement("button");
              tableButton.className = "list-group-item list-group-item-action";
              tableButton.textContent = `–°—Ç–æ–ª–∏–∫ ‚Ññ${table.name} (${table.seats} –º–µ—Å—Ç)`;
              tableButton.dataset.tableId = table.id;

              tableButton.addEventListener("click", function() {
                document.querySelectorAll(".list-group-item").forEach(btn => btn.classList.remove("active"));
                this.classList.add("active");
                selectedTableInput.value = this.dataset.tableId;
                bookingDate.disabled = false;
              });

              tableList.appendChild(tableButton);
            });
          } else {
            tableList.innerHTML = '<p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–æ–ª–∏–∫–æ–≤.</p>';
          }
        })
        .catch(error => {
          tableList.innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–æ–ª–∏–∫–æ–≤.</p>';
          console.error(error);
        });
    });

    bookingDate.addEventListener("input", function() {
      confirmButton.disabled = !this.value || !selectedTableInput.value;
    });
  });
</script>
<script src="{% static 'js/booking.js' %}"></script>
{% endblock %}
